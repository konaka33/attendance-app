# Google Apps Script セットアップガイド

## 前提条件

- Googleアカウント
- LINE Messaging API のチャネルアクセストークン（提供済み）
- LINE グループID（提供済み）

## セットアップ手順

### 1. Google Spreadsheet の作成

1. [Google Drive](https://drive.google.com) にアクセス
2. 「新規」→「Google スプレッドシート」→「空白のスプレッドシート」
3. スプレッドシート名を「出退勤打刻アプリ - データ」に変更

### 2. シート構成の作成

Apps Scriptが自動的にシートを作成しますが、事前に作成しておくこともできます：

#### シート1: 研修生マスタ
| 研修生ID | 氏名 | ステータス |
|---------|------|-----------|
| user01  | konaka33 | 進行中 |

#### シート2: 打刻記録
| 日付 | 研修生ID | 氏名 | 出勤時刻 | 退勤時刻 | 勤務時間 |
|------|---------|------|---------|---------|---------|
| （自動記録） | | | | | |

#### シート3: 課題完了記録
| 完了日時 | 研修生ID | 氏名 | アプリURL | 判定 |
|---------|---------|------|----------|------|
| （自動記録） | | | | |

### 3. Apps Script の設定

1. スプレッドシートで「拡張機能」→「Apps Script」を選択
2. エディタが開いたら、デフォルトのコードを削除
3. [Code.gs](Code.gs) の内容をコピー&ペースト
4. **重要**: 以下の設定値を確認
   ```javascript
   const LINE_CHANNEL_ACCESS_TOKEN = 'YOZ7Uft...（提供済み）';
   const LINE_GROUP_ID = 'C5a5b36e...（提供済み）';
   ```
5. 「プロジェクト名」を「出退勤打刻アプリAPI」に変更
6. 保存（Ctrl+S または Cmd+S）

### 4. デプロイ

1. 右上の「デプロイ」→「新しいデプロイ」をクリック
2. 「種類の選択」（歯車アイコン）で「ウェブアプリ」を選択
3. 設定内容:
   - **説明**: 出退勤打刻アプリ v1
   - **次のユーザーとして実行**: 自分
   - **アクセスできるユーザー**: 全員
4. 「デプロイ」ボタンをクリック
5. 初回は「アクセスを承認」が必要
   - 「承認」をクリック
   - Googleアカウントを選択
   - 「詳細」→「(プロジェクト名)に移動」をクリック
   - 「許可」をクリック

### 5. Web App URL の取得

1. デプロイが完了すると、「ウェブアプリ」のURLが表示される
2. このURLをコピー
   ```
   例: https://script.google.com/macros/s/ABC...XYZ/exec
   ```

### 6. main.js に URL を設定

1. プロジェクトの [main.js](../main.js) を開く
2. 2行目の `GAS_WEB_APP_URL` にURLを設定
   ```javascript
   const CONFIG = {
       GAS_WEB_APP_URL: 'https://script.google.com/macros/s/ABC...XYZ/exec',
       // ...
   };
   ```
3. ファイルを保存

### 7. 動作確認

#### テスト1: 出勤打刻
1. ブラウザで index.html を開く
2. 「出勤」ボタンをタップ
3. 以下を確認:
   - ✅ ローディングが表示される
   - ✅ 「出勤を記録しました」トーストが表示される
   - ✅ 本日の記録に出勤時刻が表示される
   - ✅ LINEグループに通知が届く
   - ✅ スプレッドシートに記録される

#### テスト2: 退勤打刻
1. 「退勤」ボタンをタップ
2. 以下を確認:
   - ✅ 勤務時間が自動計算される
   - ✅ LINEグループに通知が届く（勤務時間含む）
   - ✅ スプレッドシートが更新される

#### テスト3: 課題完了報告
1. 「🎉 課題完了報告」ボタンをタップ
2. 確認ダイアログで「OK」
3. LINEグループに課題完了通知が届く

## トラブルシューティング

### エラー: 「このアプリは確認されていません」
- 「詳細」→「(プロジェクト名)に移動」をクリックして進める
- 自分自身のスクリプトなので安全です

### エラー: 「GAS_WEB_APP_URLが設定されていません」
- main.js の CONFIG.GAS_WEB_APP_URL が正しく設定されているか確認
- URLの前後に空白やクォートの抜けがないか確認

### LINE通知が届かない
- LINE_CHANNEL_ACCESS_TOKEN が正しいか確認
- LINE_GROUP_ID が正しいか確認
- Apps Script の「実行ログ」でエラーを確認
  1. Apps Script エディタを開く
  2. 左メニューの「実行数」をクリック
  3. エラーログを確認

### データが記録されない
- スプレッドシートの権限を確認
- Apps Script の「実行ログ」を確認
- デプロイ時に「アクセスできるユーザー: 全員」を選択したか確認

## デバッグ方法

### Apps Script のログ確認
1. Apps Script エディタを開く
2. 左メニューの「実行数」をクリック
3. 最新の実行ログを確認
4. `Logger.log()` の出力を確認

### テスト関数の実行
Apps Script エディタで以下の関数を手動実行してテスト:

```javascript
// テストデータ作成
function testCreateData() {
  const sheet = getOrCreateSheet('打刻記録');
  Logger.log('シート作成完了');
}

// LINE通知テスト
function testLineNotification() {
  sendLineNotification('テスト通知');
  Logger.log('LINE通知送信完了');
}
```

## 注意事項

- 無料版の Google Apps Script には実行時間制限（6分/実行）があります
- LINE Messaging API の無料プランには月1000通の制限があります
- スプレッドシートは編集権限を管理者のみに制限してください
- URL は公開されるため、機密データは保存しないでください

## 更新方法

コードを更新した場合:

1. Apps Script エディタでコードを修正
2. 保存（Ctrl+S）
3. 「デプロイ」→「デプロイを管理」
4. 現在のデプロイの「編集」（鉛筆アイコン）
5. 「バージョン」→「新バージョン」
6. 「デプロイ」

URLは変わらないので、main.js の変更は不要です。
